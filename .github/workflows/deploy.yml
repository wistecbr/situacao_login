name: ðŸš€ Deploy website on push

on: 
  pull_request:
    branches:
      - develop
      - main
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v3

      - name: ðŸšš Create .env and HOST
        run: echo HOST='"${{secrets.db_host}}"' > .env

      - name: ðŸšš Set User .env
        run: echo USER='"${{secrets.db_user}}"' >> .env

      - name: ðŸšš Set Pass .env
        run: echo PASSWORD='"${{secrets.db_pass}}"' >> .env

      - name: ðŸšš Set DataBase .env
        run: echo DATABASE='"${{secrets.db_database}}"' >> .env

      - name: Extract branch name
        id: extract_branch
        env:
          GITHUB_REF: ${{github.ref}}
          GITHUB_HEAD_REF: ${{github.head_ref}}
        run: |
          if [ ${{github.event_name}} != 'pull_request' ] ; then
            echo "::set-output name=name::${GITHUB_REF#refs/heads/}"
          else 
            echo "::set-output name=name::${GITHUB_HEAD_REF}"
          fi
      - name: Set local dir
        id: set_local_dir
        env:
          BRANCH_NAME: ${{steps.extract_branch.outputs.name}}
        run: echo "::set-output name=name::htdocs/"$BRANCH_NAME"/"

      - name: Print local dir
        env: 
          LOCAL_DIR: ${{steps.set_local_dir.outputs.name}}
        run: echo 'The branch name is'  $LOCAL_DIR

      - name: ðŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@4.2.0
        with:
          server: ${{ secrets.ftp_host }}
          username: ${{ secrets.ftp_user }}
          password: ${{ secrets.ftp_pass }}
          server-dir: ${{ steps.set_local_dir.outputs.name }}